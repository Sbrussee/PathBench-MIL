<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pathbench.models.feature_extractors &mdash; PathBench 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PathBench
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmarking_mode.html">Benchmarking Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization_mode.html">Optimization Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualization_application.html">Visualization Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ensemble_model_creation.html">Ensemble Model Creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending_pathbench.html">Extending PathBench</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../feature_extractors.html">Feature Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mil_aggregators.html">MIL Aggregators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PathBench</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pathbench.models.feature_extractors</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pathbench.models.feature_extractors</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">slideflow</span> <span class="kn">import</span> <span class="n">mil</span>
<span class="kn">from</span> <span class="nn">slideflow.model.extractors._factory_torch</span> <span class="kn">import</span> <span class="n">TorchFeatureExtractor</span>
<span class="kn">from</span> <span class="nn">slideflow.model.extractors</span> <span class="kn">import</span> <span class="n">register_torch</span>
<span class="kn">from</span> <span class="nn">torchvision.models.resnet</span> <span class="kn">import</span> <span class="n">Bottleneck</span><span class="p">,</span> <span class="n">ResNet</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>

<span class="kn">import</span> <span class="nn">timm</span>
<span class="kn">from</span> <span class="nn">timm.data</span> <span class="kn">import</span> <span class="n">resolve_data_config</span>
<span class="kn">from</span> <span class="nn">timm.data.transforms_factory</span> <span class="kn">import</span> <span class="n">create_transform</span>
<span class="kn">from</span> <span class="nn">timm.models.vision_transformer</span> <span class="kn">import</span> <span class="n">VisionTransformer</span><span class="p">,</span> <span class="n">_cfg</span>
<span class="kn">from</span> <span class="nn">timm.models.layers</span> <span class="kn">import</span> <span class="n">PatchEmbed</span>
<span class="kn">from</span> <span class="nn">timm.layers</span> <span class="kn">import</span> <span class="n">SwiGLUPacked</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoImageProcessor</span><span class="p">,</span> <span class="n">ViTModel</span><span class="p">,</span> <span class="n">AutoModel</span>
<span class="kn">from</span> <span class="nn">huggingface_hub</span> <span class="kn">import</span> <span class="n">login</span><span class="p">,</span> <span class="n">hf_hub_download</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>


<span class="c1"># Directory to save pretrained weights</span>
<span class="n">WEIGHTS_DIR</span> <span class="o">=</span> <span class="s2">&quot;pretrained_weights&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TORCH_HOME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HF_HOME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>

<span class="c1"># Get Hugging Face API keys from environment variables</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;HF_TOKEN&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="get_pretrained_url_vit">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.get_pretrained_url_vit">[docs]</a>
<span class="k">def</span> <span class="nf">get_pretrained_url_vit</span><span class="p">(</span><span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URL for the pretrained weights of the Vision Transformer model</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): The key for the model</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: The URL for the pretrained weights of the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">URL_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/lunit-io/benchmark-ssl-pathology/releases/download/pretrained-weights&quot;</span>
    <span class="n">model_zoo_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;DINO_p16&quot;</span><span class="p">:</span> <span class="s2">&quot;dino_vit_small_patch16_ep200.torch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DINO_p8&quot;</span><span class="p">:</span> <span class="s2">&quot;dino_vit_small_patch8_ep200.torch&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">pretrained_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_PREFIX</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_zoo_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">pretrained_url</span></div>


<div class="viewcode-block" id="vit_small">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.vit_small">[docs]</a>
<span class="k">def</span> <span class="nf">vit_small</span><span class="p">(</span><span class="n">pretrained</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">progress</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the Vision Transformer model with small configuration</span>

<span class="sd">    Args:</span>
<span class="sd">        pretrained (bool): Whether to load the pretrained weights</span>
<span class="sd">        progress (bool): Whether to show the download progress</span>
<span class="sd">        key (str): The key for the model</span>
<span class="sd">        **kwargs: Additional keyword arguments</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        VisionTransformer: The ViT-Small model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patch_size&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">VisionTransformer</span><span class="p">(</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
        <span class="n">pretrained_url</span> <span class="o">=</span> <span class="n">get_pretrained_url_vit</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WEIGHTS_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.torch&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weights_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">WEIGHTS_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading pretrained weights for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">download_url_to_file</span><span class="p">(</span><span class="n">pretrained_url</span><span class="p">,</span> <span class="n">weights_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pretrained weights downloaded successfully.&quot;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>



<div class="viewcode-block" id="ResNetTrunk">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.ResNetTrunk">[docs]</a>
<span class="k">class</span> <span class="nc">ResNetTrunk</span><span class="p">(</span><span class="n">ResNet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ResNet trunk without the final fully connected layer</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : list</span>
<span class="sd">        Variable length argument list</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Keyword arguments</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    fc : nn.Linear</span>
<span class="sd">        Fully connected</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    forward(x)</span>
<span class="sd">        Forward pass of the model</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ResNetTrunk.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.ResNetTrunk.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span>  <span class="c1"># remove FC layer</span></div>


<div class="viewcode-block" id="ResNetTrunk.forward">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.ResNetTrunk.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">adaptive_avg_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Global average pooling</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flatten to (batch_size, num_features)</span>
        <span class="k">return</span> <span class="n">x</span></div>
</div>


<div class="viewcode-block" id="get_pretrained_url">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.get_pretrained_url">[docs]</a>
<span class="k">def</span> <span class="nf">get_pretrained_url</span><span class="p">(</span><span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URL for the pretrained weights of the model</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): The key for the model</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: The URL for the pretrained weights of the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">URL_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/lunit-io/benchmark-ssl-pathology/releases/download/pretrained-weights&quot;</span>
    <span class="n">model_zoo_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BT&quot;</span><span class="p">:</span> <span class="s2">&quot;bt_rn50_ep200.torch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MoCoV2&quot;</span><span class="p">:</span> <span class="s2">&quot;mocov2_rn50_ep200.torch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SwAV&quot;</span><span class="p">:</span> <span class="s2">&quot;swav_rn50_ep200.torch&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">pretrained_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_PREFIX</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_zoo_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">pretrained_url</span></div>


<div class="viewcode-block" id="download_pretrained_weights">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.download_pretrained_weights">[docs]</a>
<span class="k">def</span> <span class="nf">download_pretrained_weights</span><span class="p">(</span><span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the pretrained weights for the model</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): The key for the model</span>
<span class="sd">        destination (str): The path to save the pretrained weights</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pretrained_url</span> <span class="o">=</span> <span class="n">get_pretrained_url</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">destination</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading pretrained weights for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">download_url_to_file</span><span class="p">(</span><span class="n">pretrained_url</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pretrained weights downloaded successfully.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pretrained weights for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> already exist, skipping download.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="resnet50">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.resnet50">[docs]</a>
<span class="k">def</span> <span class="nf">resnet50</span><span class="p">(</span><span class="n">pretrained</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">progress</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the ResNet-50 model</span>

<span class="sd">    Args:</span>
<span class="sd">        pretrained (bool): Whether to load the pretrained weights</span>
<span class="sd">        progress (bool): Whether to show the download progress</span>
<span class="sd">        key (str): The key for the model</span>
<span class="sd">        **kwargs: Additional keyword arguments</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        ResNetTrunk: The ResNet-50 model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ResNetTrunk</span><span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WEIGHTS_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.torch&quot;</span><span class="p">)</span>
        <span class="n">download_pretrained_weights</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">weights_path</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="dino">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.dino">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">dino</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lunit-IO DINO feature extractor, with ViT-Small backbone</span>
<span class="sd">    https://openaccess.thecvf.com/content/CVPR2023/html/Kang_Benchmarking_Self-Supervised_Learning_on_Diverse_Pathology_Datasets_CVPR_2023_paper.html</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;dino&quot;</span>

<div class="viewcode-block" id="dino.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.dino.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">vit_small</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;DINO_p16&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="dino.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.dino.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;dino&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="barlow_twins">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.barlow_twins">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">barlow_twins</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lunit-IO Barlow Twins feature extractor, with ResNet-50 backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ResNet50 truncated</span>
<span class="sd">        The ResNet-50 model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;barlow_twins&#39;</span>

<div class="viewcode-block" id="barlow_twins.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.barlow_twins.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Load ResNet50 trunk with Barlow Twins pre-trained weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;BT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>  <span class="c1"># Move model to GPU if available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Set the model to evaluation mode</span>

        <span class="c1"># Set the number of features generated by the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">2048</span>  <span class="c1"># Assuming ResNet50 output features of size 2048</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="barlow_twins.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.barlow_twins.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;barlow_twins&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="mocov2">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.mocov2">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">mocov2</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lunit-IO MoCoV2 feature extractor, with ResNet-50 backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ResNet50 truncated</span>
<span class="sd">        The ResNet-50 model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;mocov2&#39;</span>

<div class="viewcode-block" id="mocov2.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.mocov2.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Load ResNet50 trunk with Barlow Twins pre-trained weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;MoCoV2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>  <span class="c1"># Move model to GPU if available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Set the model to evaluation mode</span>

        <span class="c1"># Set the number of features generated by the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">2048</span>  <span class="c1"># Assuming ResNet50 output features of size 2048</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="mocov2.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.mocov2.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;mocov2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="swav">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.swav">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">swav</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lunit-IO SwAV feature extractor, with ResNet-50 backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : ResNet50 truncated</span>
<span class="sd">        The ResNet-50 model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;swav&#39;</span>

<div class="viewcode-block" id="swav.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.swav.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Load ResNet50 trunk with Barlow Twins pre-trained weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;SwAV&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>  <span class="c1"># Move model to GPU if available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># Set the model to evaluation mode</span>

        <span class="c1"># Set the number of features generated by the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">2048</span>  <span class="c1"># Assuming ResNet50 output features of size 2048</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="swav.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.swav.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;swav&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>

    

<span class="c1">#NEEDS KEY</span>
<div class="viewcode-block" id="uni">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.uni">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">uni</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UNI feature extractor, with ViT-Large backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;uni&quot;</span>

<div class="viewcode-block" id="uni.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.uni.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">login</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;uni.bin&quot;</span>
        <span class="n">model_temp_name</span> <span class="o">=</span> <span class="s2">&quot;pytorch_model.bin&quot;</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
            <span class="n">temp_model_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="s2">&quot;MahmoodLab/UNI&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_temp_name</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="n">local_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_model_path</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span>
            <span class="s2">&quot;vit_large_patch16_224&quot;</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">init_values</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">1024</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="uni.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.uni.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;uni&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="phikon">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.phikon">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">phikon</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phikon feature extractor, with ViT-Large backbone</span>

<span class="sd">    Parameters    </span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;phikon&#39;</span>

<div class="viewcode-block" id="phikon.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.phikon.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>

        <span class="c1"># Load the pre-trained phikon model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">ViTModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;owkin/phikon&quot;</span><span class="p">,</span> <span class="n">add_pooling_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>

        <span class="c1"># Internal class for the modified model</span>
        <span class="k">class</span> <span class="nc">PhikonEmbedder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">num_features</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">PhikonEmbedder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="n">num_features</span>

            <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="c1"># Get features from the base model</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">features</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: [batch_size, hidden_size]</span>
                <span class="k">return</span> <span class="n">features</span>

        <span class="c1"># Initialize the modified model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PhikonEmbedder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="phikon.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.phikon.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;phikon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<span class="c1">#NEEDS KEY</span>
<div class="viewcode-block" id="gigapath">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.gigapath">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">gigapath</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prov-GigaPath feature extractor, with Vision Transformer backbone</span>

<span class="sd">    Parameters    </span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;gigapath&#39;</span>

<div class="viewcode-block" id="gigapath.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.gigapath.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;gigapath.bin&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span>
                <span class="s2">&quot;hf_hub:prov-gigapath/prov-gigapath&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span>
                <span class="s2">&quot;hf_hub:prov-gigapath/prov-gigapath&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="gigapath.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.gigapath.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;gigapath&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="kaiko_s8">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_s8">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">kaiko_s8</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kaiko S8 feature extractor, with small Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;kaiko_s8&#39;</span>

<div class="viewcode-block" id="kaiko_s8.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_s8.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;kaiko-ai/towards_large_pathology_fms&quot;</span><span class="p">,</span> <span class="s1">&#39;vits8&#39;</span><span class="p">,</span> <span class="n">trust_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">384</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="kaiko_s8.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_s8.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;kaiko_s8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="kaiko_s16">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_s16">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">kaiko_s16</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kaiko S16 feature extractor, with small Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;kaiko_s16&#39;</span>

<div class="viewcode-block" id="kaiko_s16.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_s16.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;kaiko-ai/towards_large_pathology_fms&quot;</span><span class="p">,</span> <span class="s1">&#39;vits16&#39;</span><span class="p">,</span> <span class="n">trust_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">384</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="kaiko_s16.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_s16.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;kaiko_s16&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="kaiko_b8">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_b8">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">kaiko_b8</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kaiko B8 feature extractor, with base Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;kaiko_b8&#39;</span>

<div class="viewcode-block" id="kaiko_b8.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_b8.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;kaiko-ai/towards_large_pathology_fms&quot;</span><span class="p">,</span> <span class="s1">&#39;vitb8&#39;</span><span class="p">,</span> <span class="n">trust_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="kaiko_b8.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_b8.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;kaiko_b8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="kaiko_b16">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_b16">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">kaiko_b16</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kaiko B16 feature extractor, with base Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;kaiko_b16&#39;</span>

<div class="viewcode-block" id="kaiko_b16.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_b16.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;kaiko-ai/towards_large_pathology_fms&quot;</span><span class="p">,</span> <span class="s1">&#39;vitb16&#39;</span><span class="p">,</span> <span class="n">trust_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="kaiko_b16.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_b16.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;kaiko_b16&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="kaiko_l14">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_l14">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">kaiko_l14</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kaiko L14 feature extractor, with large Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;kaiko_l14&#39;</span>

<div class="viewcode-block" id="kaiko_l14.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_l14.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;kaiko-ai/towards_large_pathology_fms&quot;</span><span class="p">,</span> <span class="s1">&#39;vitl14&#39;</span><span class="p">,</span> <span class="n">trust_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="c1"># Transform to float tensor</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="kaiko_l14.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.kaiko_l14.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;kaiko_l14&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<span class="c1">#TODO: Implement CONCH</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@register_torch</span>
<span class="sd">class conch(TorchFeatureExtractor):</span>
<span class="sd">    def __init__(self, tile_px=256):</span>
<span class="sd">        super().__init__()</span>
<span class="sd">        self.model = create_model_from_pretrained(&quot;conch_ViT-B-16&quot;, &quot;hf_hub:MahmoodLab/conch&quot;, hf_auth_token=keys[&#39;conch&#39;])</span>
<span class="sd">        self.model.to(&#39;cuda&#39;)</span>
<span class="sd">        self.num_features = 1024</span>
<span class="sd">        self.transform = transforms.Compose(</span>
<span class="sd">            [</span>
<span class="sd">                transforms.Resize(224),</span>
<span class="sd">                # Transform to float tensor</span>
<span class="sd">                transforms.ConvertImageDtype(torch.float32),</span>
<span class="sd">                transforms.Normalize(mean=(0.485, 0.456, 0.406), std=(0.229, 0.224, 0.225)),</span>
<span class="sd">            ]</span>
<span class="sd">        )</span>
<span class="sd">        self.model.eval()</span>
<span class="sd">        # Slideflow standardization</span>
<span class="sd">        self.preprocess_kwargs = {&#39;standardize&#39;: False}</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead">[docs]</a>
<span class="k">class</span> <span class="nc">VisionTransformerMoCoWithoutHead</span><span class="p">(</span><span class="n">VisionTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vision Transformer model with MoCo pretraining, without the final fully connected layer</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : list</span>
<span class="sd">        Variable length argument list</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Keyword arguments</span>
<span class="sd">    pretext_token : bool</span>
<span class="sd">        Whether to add a pretext token</span>
<span class="sd">    stop_grad_conv1 : bool</span>
<span class="sd">        Whether to stop gradient for the first convolutional layer</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_prefix_tokens : int</span>
<span class="sd">        The number of prefix tokens</span>
<span class="sd">    pretext_token : nn.Parameter</span>
<span class="sd">        The pretext token</span>
<span class="sd">    embed_len : int</span>
<span class="sd">        The length of the embedding</span>
<span class="sd">    pos_embed : nn.Parameter</span>
<span class="sd">        The positional embedding</span>
<span class="sd">    embed_dim : int</span>
<span class="sd">        The embedding dimension</span>
<span class="sd">    patch_embed : PatchEmbed</span>
<span class="sd">        The patch embedding layer</span>
<span class="sd">    pos_drop : nn.Dropout</span>
<span class="sd">        The positional dropout layer</span>
<span class="sd">    blocks : nn.Sequential</span>
<span class="sd">        The transformer blocks</span>
<span class="sd">    norm : nn.LayerNorm</span>
<span class="sd">        The layer normalization layer</span>
<span class="sd">    cls_token : nn.Parameter</span>
<span class="sd">        The class token</span>
<span class="sd">    dist_token : nn.Parameter</span>
<span class="sd">        The distance token</span>
<span class="sd">    norm_pre : nn.LayerNorm</span>
<span class="sd">        The layer normalization layer for the prefix tokens</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    _pos_embed(x)</span>
<span class="sd">        Add positional embedding to the input tensor</span>
<span class="sd">    _ref_embed(ref)</span>
<span class="sd">        Add positional embedding to the reference tensor</span>
<span class="sd">    _pos_embed_with_ref(x, ref)</span>
<span class="sd">        Add positional embedding to the input tensor with reference</span>
<span class="sd">    forward_features(x, ref)</span>
<span class="sd">        Forward pass of the model for features</span>
<span class="sd">    forward(x, ref)</span>
<span class="sd">        Forward pass of the model</span>
<span class="sd">    build_2d_sincos_position_embedding()</span>
<span class="sd">        Build 2D sin-cos position embedding</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretext_token</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stop_grad_conv1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># inserting a new token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_prefix_tokens</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">pretext_token</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">))</span> <span class="k">if</span> <span class="n">pretext_token</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">embed_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">num_patches</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_embed_class</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">num_patches</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">embed_len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pretext_token</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_len</span> <span class="o">=</span> <span class="n">embed_len</span>

        <span class="c1"># Use fixed 2D sin-cos position embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_2d_sincos_position_embedding</span><span class="p">()</span>

        <span class="c1"># weight initialization</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;qkv&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c1"># treat the weights of Q, K, V separately</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="o">-</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="p">,</span> <span class="n">PatchEmbed</span><span class="p">):</span>
            <span class="c1"># xavier_uniform initialization</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">patch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">))</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="o">-</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stop_grad_conv1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead.no_weight_decay">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead.no_weight_decay">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">ignore</span>
    <span class="k">def</span> <span class="nf">no_weight_decay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pos_embed&#39;</span><span class="p">,</span> <span class="s1">&#39;cls_token&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_token&#39;</span><span class="p">,</span> <span class="s1">&#39;pretext_token&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead._pos_embed">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead._pos_embed">[docs]</a>
    <span class="k">def</span> <span class="nf">_pos_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_embed_class</span><span class="p">:</span>
            <span class="c1"># deit-3, updated JAX (big vision)</span>
            <span class="c1"># position embedding does not overlap with class token, add then concat</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># original timm, JAX, and deit vit impl</span>
            <span class="c1"># pos_embed has entry for class token, concat then add</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead._ref_embed">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead._ref_embed">[docs]</a>
    <span class="k">def</span> <span class="nf">_ref_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">flatten</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># BCHW -&gt; BNC</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ref</span></div>


<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead._pos_embed_with_ref">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead._pos_embed_with_ref">[docs]</a>
    <span class="k">def</span> <span class="nf">_pos_embed_with_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="n">pretext_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">ref</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_embed_class</span><span class="p">:</span>
            <span class="c1"># deit-3, updated JAX (big vision)</span>
            <span class="c1"># position embedding does not overlap with class token, add then concat</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pretext_tokens</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># original timm, JAX, and deit vit impl</span>
            <span class="c1"># pos_embed has entry for class token, concat then add</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretext_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pretext_tokens</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead.forward_features">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead.forward_features">[docs]</a>
    <span class="k">def</span> <span class="nf">forward_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_embed</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_embed_with_ref</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
        <span class="c1"># x = self.norm_pre(x)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_checkpointing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_seq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead.forward">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_features</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
        <span class="c1">#Average the features to reduce the dimensionality</span>
        <span class="n">x_out</span> <span class="o">=</span> <span class="n">x_out</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_out</span></div>


<div class="viewcode-block" id="VisionTransformerMoCoWithoutHead.build_2d_sincos_position_embedding">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.VisionTransformerMoCoWithoutHead.build_2d_sincos_position_embedding">[docs]</a>
    <span class="k">def</span> <span class="nf">build_2d_sincos_position_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">10000.</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">grid_size</span>
        <span class="n">grid_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">grid_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">grid_w</span><span class="p">,</span> <span class="n">grid_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">grid_w</span><span class="p">,</span> <span class="n">grid_h</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Embed dimension must be divisible by 4 for 2D sin-cos position embedding&#39;</span>
        <span class="n">pos_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pos_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">pos_dim</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">temperature</span><span class="o">**</span><span class="n">omega</span><span class="p">)</span>
        <span class="n">out_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;m,d-&gt;md&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">grid_w</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">omega</span><span class="p">])</span>
        <span class="n">out_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;m,d-&gt;md&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">grid_h</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">omega</span><span class="p">])</span>
        <span class="n">pos_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">out_w</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">out_w</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">out_h</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">out_h</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_prefix_tokens</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Assuming two and only two tokens, [pretext][cls]&#39;</span>
        <span class="n">pe_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">pe_token</span><span class="p">,</span> <span class="n">pos_emb</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>

        
<span class="c1">#NEEDS LOCAL WEIGHTS</span>
<div class="viewcode-block" id="pathoduet_he">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.pathoduet_he">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">pathoduet_he</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PathoDuet HE-trained feature extractor, with Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformerMoCoWithoutHead   </span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict   </span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;pathoduet_he&#39;</span>

<div class="viewcode-block" id="pathoduet_he.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.pathoduet_he.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">VisionTransformerMoCoWithoutHead</span><span class="p">(</span><span class="n">pretext_token</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">global_pool</span><span class="o">=</span><span class="s1">&#39;avg&#39;</span><span class="p">)</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">WEIGHTS_DIR</span><span class="si">}</span><span class="s1">/checkpoint_HE.pth&#39;</span><span class="p">)</span>
        <span class="c1"># Remove the &#39;head.weight&#39; and &#39;head.bias&#39; keys from the state dictionary</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;head.&#39;</span><span class="p">)}</span>

        <span class="c1"># Load the modified state dictionary into your model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="pathoduet_he.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.pathoduet_he.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;pathoduet_he&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<span class="c1">#NEEDS LOCAL WEIGHTS</span>
<div class="viewcode-block" id="pathoduet_ihc">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.pathoduet_ihc">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">pathoduet_ihc</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PathoDuet IHC-trained feature extractor, with Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformerMoCoWithoutHead   </span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict   </span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;pathoduet_ihc&#39;</span>

<div class="viewcode-block" id="pathoduet_ihc.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.pathoduet_ihc.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">VisionTransformerMoCoWithoutHead</span><span class="p">(</span><span class="n">pretext_token</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">global_pool</span><span class="o">=</span><span class="s1">&#39;avg&#39;</span><span class="p">)</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">WEIGHTS_DIR</span><span class="si">}</span><span class="s1">/checkpoint_IHC.pth&#39;</span><span class="p">)</span>
        <span class="c1"># Remove the &#39;head.weight&#39; and &#39;head.bias&#39; keys from the state dictionary</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;head.&#39;</span><span class="p">)}</span>
        <span class="c1"># Load the modified state dictionary into your model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>



<div class="viewcode-block" id="pathoduet_ihc.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.pathoduet_ihc.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;pathoduet_ihc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="hibou_b">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.hibou_b">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">hibou_b</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hibou B feature extractor, with base Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : HibouEmbedder</span>
<span class="sd">        The Hibou model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;hibou_b&#39;</span>

<div class="viewcode-block" id="hibou_b.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.hibou_b.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;hibou_b&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">AutoImageProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;histai/hibou-b&quot;</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;histai/hibou-b&quot;</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Add a new head to include adaptive average pooling</span>
        <span class="k">class</span> <span class="nc">HibouEmbedder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Hibou Embedder model, which adds mean pooling to the base model.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            base_model : nn.Module</span>
<span class="sd">                The base Hibou-B model</span>
<span class="sd">            </span>
<span class="sd">            Methods</span>
<span class="sd">            -------</span>
<span class="sd">            forward(x)</span>
<span class="sd">                Forward pass of the model</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">HibouEmbedder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
                

            <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="c1"># Apply adaptive average pooling</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">x</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">HibouEmbedder</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7068</span><span class="p">,</span> <span class="mf">0.5655</span><span class="p">,</span> <span class="mf">0.722</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.195</span><span class="p">,</span> <span class="mf">0.2316</span><span class="p">,</span> <span class="mf">0.1816</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="hibou_b.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.hibou_b.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;hibou_b&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<span class="c1">#GATED</span>
<div class="viewcode-block" id="hibou_l">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.hibou_l">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">hibou_l</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hibou L feature extractor, with large Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : HibouEmbedder</span>
<span class="sd">        The Hibou model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;hibou_l&#39;</span>

<div class="viewcode-block" id="hibou_l.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.hibou_l.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;hibou_l&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">AutoImageProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;histai/hibou-l&quot;</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;histai/hibou-l&quot;</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Add a new head to include adaptive average pooling</span>
        <span class="k">class</span> <span class="nc">HibouEmbedder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Hibou Embedder model, which adds mean pooling to the base model.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            base_model : nn.Module</span>
<span class="sd">                The base Hibou-L model</span>
<span class="sd">            </span>
<span class="sd">            Methods</span>
<span class="sd">            -------</span>
<span class="sd">            forward(x)</span>
<span class="sd">                Forward pass of the model</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">HibouEmbedder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
                

            <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="c1"># Apply adaptive average pooling</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">x</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">HibouEmbedder</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7068</span><span class="p">,</span> <span class="mf">0.5655</span><span class="p">,</span> <span class="mf">0.722</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.195</span><span class="p">,</span> <span class="mf">0.2316</span><span class="p">,</span> <span class="mf">0.1816</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="hibou_l.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.hibou_l.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;hibou_l&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>

<span class="c1">#GATED</span>
<div class="viewcode-block" id="virchow">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.virchow">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">virchow</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Virchow feature extractor, with Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>

<span class="sd">    Attributes</span>
<span class="sd">    ---------- </span>
<span class="sd">    model : VirchowEmbedder</span>
<span class="sd">        The Virchow model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict   </span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;virchow&#39;</span>

<div class="viewcode-block" id="virchow.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.virchow.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="s2">&quot;hf-hub:paige-ai/Virchow&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">mlp_layer</span><span class="o">=</span><span class="n">SwiGLUPacked</span><span class="p">,</span> <span class="n">act_layer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">)</span>
        <span class="n">base_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

        <span class="c1"># Modify the classifier to output the concatenated embeddings</span>
        <span class="k">class</span> <span class="nc">VirchowEmbedder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Virchow Embedder model, which concatenates the class token and average pool of patch tokens.</span>

<span class="sd">            Methods</span>
<span class="sd">            -------</span>
<span class="sd">            forward(x)</span>
<span class="sd">                Forward pass of the model</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">VirchowEmbedder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">cls_token</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">patch_tokens</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="n">avg_pool</span> <span class="o">=</span> <span class="n">patch_tokens</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Concatenate class token and average pool of patch tokens</span>
                <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cls_token</span><span class="p">,</span> <span class="n">avg_pool</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">embedding</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">VirchowEmbedder</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">2560</span>  <span class="c1"># Update the number of features to reflect the new embedding size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="virchow.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.virchow.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;virchow&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="virchow2">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.virchow2">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">virchow2</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Virchow2 feature extractor, with Huge Vision Transformer backbone.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;virchow2&#39;</span>

<div class="viewcode-block" id="virchow2.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.virchow2.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">WEIGHTS_DIR</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="s2">&quot;hf-hub:paige-ai/Virchow2&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">mlp_layer</span><span class="o">=</span><span class="n">SwiGLUPacked</span><span class="p">,</span> <span class="n">act_layer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">)</span>
        <span class="n">base_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

        <span class="c1"># Modify the classifier to output the concatenated embeddings</span>
        <span class="k">class</span> <span class="nc">VirchowEmbedder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Virchow Embedder model, which concatenates the class token and average pool of patch tokens.</span>

<span class="sd">            Methods</span>
<span class="sd">            -------</span>
<span class="sd">            forward(x)</span>
<span class="sd">                Forward pass of the model</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">VirchowEmbedder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">cls_token</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">patch_tokens</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span>
                <span class="n">avg_pool</span> <span class="o">=</span> <span class="n">patch_tokens</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Concatenate class token and average pool of patch tokens</span>
                <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cls_token</span><span class="p">,</span> <span class="n">avg_pool</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">embedding</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">VirchowEmbedder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>  
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">1280</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="virchow2.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.virchow2.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;virchow2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="h_optimus_0">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.h_optimus_0">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">h_optimus_0</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    H-Optimus feature extractor, with large Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;h_optimus_0&#39;</span>

<div class="viewcode-block" id="h_optimus_0.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.h_optimus_0.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span>
            <span class="s2">&quot;hf-hub:bioptimus/H-optimus-0&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_values</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">dynamic_img_size</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
                <span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.707223</span><span class="p">,</span> <span class="mf">0.578729</span><span class="p">,</span> <span class="mf">0.703617</span><span class="p">),</span> 
                <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.211883</span><span class="p">,</span> <span class="mf">0.230117</span><span class="p">,</span> <span class="mf">0.177517</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">])</span>
        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="h_optimus_0.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.h_optimus_0.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;h_optimus_0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="transpath_mocov3">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.transpath_mocov3">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">transpath_mocov3</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TransPath MoCoV3 feature extractor, with small Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;transpath_mocov3&#39;</span>

<div class="viewcode-block" id="transpath_mocov3.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.transpath_mocov3.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;hf-hub:1aurent/vit_small_patch16_224.transpath_mocov3&quot;</span><span class="p">,</span>
            <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">384</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="transpath_mocov3.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.transpath_mocov3.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;transpath_mocov3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>



<span class="c1">#TODO: Correct implementation of the model, does not work right now.</span>
<div class="viewcode-block" id="beph">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.beph">[docs]</a>
<span class="nd">@register_torch</span>
<span class="k">class</span> <span class="nc">beph</span><span class="p">(</span><span class="n">TorchFeatureExtractor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    BEPH feature extractor, with base Vision Transformer backbone</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tile_px : int</span>
<span class="sd">        The size of the tile</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : VisionTransformer</span>
<span class="sd">        The Vision Transformer model</span>
<span class="sd">    transform : torchvision.transforms.Compose</span>
<span class="sd">        The transformation pipeline</span>
<span class="sd">    preprocess_kwargs : dict</span>
<span class="sd">        The preprocessing arguments</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    dump_config()</span>
<span class="sd">        Dump the configuration of the feature extractor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;beph&#39;</span>

<div class="viewcode-block" id="beph.__init__">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.beph.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WEIGHTS_DIR</span><span class="si">}</span><span class="s2">/BEPH_backbone.pth&quot;</span><span class="p">)[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="s1">&#39;beitv2_base_patch16_224.in1k_ft_in22k_in1k&#39;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="c1">#Load the state dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="mi">384</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Slideflow standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standardize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="beph.dump_config">
<a class="viewcode-back" href="../../../pathbench_models.html#pathbench.models.feature_extractors.beph.dump_config">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;beph&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>
</div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Siemen Brussee.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>